---
title: "RNAseq_production_cell"
output: html_notebook
---


##### Load all the libraries needed for the analysis and set working directory
```{r}
source("https://bioconductor.org/biocLite.R")

biocLite("limma","gplots","edgeR","org.Hs.eg.db","RColorBrewer","ALL","GO.db","annotate","genefilter","GOstats","RColorBrewer","xtable","DBI")
library("limma")
library("gplots")
library("edgeR")
library("org.Hs.eg.db")
library("RColorBrewer")
library("ALL")
library("GO.db")
library("annotate")
library("genefilter")
library("GOstats")
library("RColorBrewer")
library("xtable")
library("DBI")
setwd("/Users/jguo/AudentesProjects/RNAseq-production-cell-YA1706202/subread_mapping")
getwd()

```

##### Load read_count file generated by subread featureCount on DNAnexus, create experimental design and DGElist object (a common data format recognized by most RNAseq data analysis packages)
## the count table could be downloaded at https://dl.dnanex.us/F/D/BjYzQFz2K2115G41BfB8V6jV50p244f8x1jvKGgy/1_S1_R1_001_hg38_analysisSet_subread_ff_count.txt).
## note that the header line of the count table has to be removed to conform to the required input format.

```{r}

data = read.delim("1_S1_R1_001_hg38_analysisSet_subread_ff_count.txt")
head(data)
str(data)
# subset columns with Gene_ID, Gene_len, and counts)
data_subset = data[,c(1,6:13)]
head(data_subset)
# set up experimental design
exp_design = read.delim("exp_design.txt")
exp_design
lev = c("prior","0h_post","24h_post","48h_post","72h_post", "96h_post","120h_post")
f = factor(exp_design$Treatment, levels=lev)
head(f)
design = model.matrix(~0+f)
colnames(design) = lev
# Generate DGE table
dge = DGEList(counts=data[,c(7:13)],genes=data[,c("Geneid","Length")], remove.zeros =TRUE, group = f)
dge
## Get log2 counts per million
logcounts = cpm(dge, log=TRUE)
## MDS plot
plotMDS(dge)

# Hierarchical clustering with heatmaps
## estimate the variance for each gene across all samples
var_genes <- apply(logcounts, 1, var)
head(var_genes)
## Get the names for the top 500 most variable genes across all samples
select_var <- names(sort(var_genes, decreasing=TRUE))[1:500]
head(select_var)

## subset logcounts matrix
highly_variable_lcpm = logcounts[select_var,]
dim(highly_variable_lcpm)
##set colours
mypalette <- brewer.pal(11,"RdYlBu")
morecols <- colorRampPalette(mypalette)
## generate heat map
heatmap.2(highly_variable_lcpm,col=rev(morecols(50)),trace="none", main="Top 500 most variable genes across samples",scale="row")

# Gene set enrichment

## use all genes that are expressed at least in one sample as universal gene set
all_expressed_gene_id = names(sort(var_genes, decreasing=TRUE))
## Rung gene set enrichment analysis with conditional 
params_conditional = new('GOHyperGParams', geneIds=select_var, universeGeneIds=all_expressed_gene_id, annotation='org.Hs.eg.db', ontology='BP', pvalueCutoff=0.01, conditional=TRUE, testDirection='over')
params = new('GOHyperGParams', geneIds=select_var, universeGeneIds=all_expressed_gene_id, annotation='org.Hs.eg.db', ontology='BP', pvalueCutoff=0.01, conditional=FALSE, testDirection='over')

hgOver = hyperGTest(params)
hgConOver = hyperGTest(params_conditional)
htmlReport(hgOver, file = "hgOver.html")
htmlReport(hgConOver, file = "hgConOver.html")

sessionInfo()
```
#####
R version 3.3.2 (2016-10-31)
Platform: x86_64-apple-darwin11.4.2 (64-bit)
Running under: macOS Sierra 10.12.6

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] stats4    parallel  stats     graphics  grDevices utils     datasets
[8] methods   base

other attached packages:
 [1] DBI_0.7              hgu95av2.db_3.2.3    org.Hs.eg.db_3.4.0
 [4] edgeR_3.16.5         gplots_3.0.1         limma_3.30.13
 [7] xtable_1.8-2         RColorBrewer_1.1-2   GOstats_2.40.0
[10] graph_1.52.0         Category_2.40.0      Matrix_1.2-12
[13] genefilter_1.56.0    annotate_1.52.1      XML_3.98-1.5
[16] GO.db_3.4.0          AnnotationDbi_1.36.2 IRanges_2.8.2
[19] S4Vectors_0.12.2     ALL_1.16.0           Biobase_2.34.0
[22] BiocGenerics_0.20.0  BiocInstaller_1.24.0

loaded via a namespace (and not attached):
 [1] Rcpp_0.12.14           bitops_1.0-6           tools_3.3.2
 [4] digest_0.6.13          bit_1.1-12             RSQLite_2.0
 [7] memoise_1.1.0          tibble_1.3.4           lattice_0.20-35
[10] pkgconfig_2.0.1        rlang_0.1.4            caTools_1.17.1
[13] gtools_3.5.0           locfit_1.5-9.1         bit64_0.9-7
[16] grid_3.3.2             GSEABase_1.36.0        survival_2.41-3
[19] RBGL_1.50.0            gdata_2.18.0           blob_1.1.0
[22] splines_3.3.2          AnnotationForge_1.16.1 KernSmooth_2.23-15
[25] RCurl_1.95-4.8


